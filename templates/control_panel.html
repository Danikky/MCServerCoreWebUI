{% extends 'base.html' %}

{% block title %}
Control panel
{% endblock %}

{% block body %}
<style>
    .console-container {
        background-color: #1d1d1d; /* Темный фон контейнера */
        border: 2px solid #404040;
        border-radius: 8px;
        padding: 10px;
        color: #e0e0e0; /* Цвет текста */
    }

    .scroll-container {
        max-height: 60vh; /* Максимальная высота 60% от высоты экрана */
        height: 900px; /* Фиксированная высота по умолчанию */
        overflow-y: auto; /* Вертикальный скролл */
        background-color: #1f1f1f;
        padding: 15px;
        border: 2px solid #333;
        margin-bottom: 20px;
    }

    .scroll-container::-webkit-scrollbar {
        width: 8px;
        background-color: #1a1a1a;
    }

    .scroll-container::-webkit-scrollbar-thumb {
        background-color: #404040;
        border-radius: 4px;
    }


    .container { max-width: 800px; margin: 0 auto; }
    .card { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .progress { height: 25px; background: #e9ecef; border-radius: 5px; overflow: hidden; margin: 10px 0; }
    .progress-bar { height: 100%; background: #0d6efd; text-align: center; color: white; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; }
    h2 { text-align: center; margin-top: 0; }
    h3 { margin-top: 0; }
</style>
<div class="container-fluid vh-100 m-0" style="padding-left: 5%; padding-right: 5%;">
    <div class="alert alert-info">
        {% if is_server_run %}
            <h1 class="text-center">Console</h1>
        {% else %}
            <h1 class="text-center">Console (Сервер выключен)</h1>
        {% endif %}
        <form method="post">
            <div id="console-output" class="console-container scroll-container">
                <!-- Контент будет обновляться через WebSocket -->
            </div>
            {% if is_server_run %}
                <br><input type="text" name="console_input" id="console_input" class="form-control", placeholder="Enter command"><br>
                <input type="submit" class="btn btn-success" value="отправить">
                <input type="submit" name="command" class="btn btn-danger float-end" value="restart">
                <input type="submit" name="command" class="btn btn-warning float-end" style="margin-right: 10px;" value="stop">
            {% else %}
                <div class="row">
                    <input type="submit" name="command" class="btn btn-success float-end" style="margin-right: 10px;" value="start">
                </div>
            {% endif %}
        </form>
    </div>
</div>
<div class="container">
    <h2>Системный мониторинг сервера</h2>
    
    <div class="card">
        <h3>Процессор (CPU)</h3>
        <div id="cpu-progress" class="progress">
            <div class="progress-bar" style="width: 0%">0%</div>
        </div>
        <div class="stats">
            <div class="stat-card">
                <div>Ядра:</div>
                <div id="cpu-cores">0</div>
            </div>
            <div class="stat-card">
                <div>Использование:</div>
                <div id="cpu-percent">0%</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Оперативная память (RAM)</h3>
        <div id="ram-progress" class="progress">
            <div class="progress-bar" style="width: 0%">0%</div>
        </div>
        <div class="stats">
            <div class="stat-card">
                <div>Всего:</div>
                <div id="ram-total">0 GB</div>
            </div>
            <div class="stat-card">
                <div>Использовано:</div>
                <div id="ram-used">0 GB</div>
            </div>
            <div class="stat-card">
                <div>Доступно:</div>
                <div id="ram-available">0 GB</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Дисковое пространство</h3>
        <div id="disk-progress" class="progress">
            <div class="progress-bar" style="width: 0%">0%</div>
        </div>
        <div class="stats">
            <div class="stat-card">
                <div>Всего:</div>
                <div id="disk-total">0 GB</div>
            </div>
            <div class="stat-card">
                <div>Использовано:</div>
                <div id="disk-used">0 GB</div>
            </div>
            <div class="stat-card">
                <div>Свободно:</div>
                <div id="disk-free">0 GB</div>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io('/server');  // Указываем Namespace

        // Обработка новых сообщений
        socket.on('console_update', function(data) {
            const consoleDiv = document.getElementById('console-output');
            const newLine = document.createElement('p');
            newLine.className = 'fonter';
            newLine.textContent = data.line;
            consoleDiv.appendChild(newLine);
            consoleDiv.scrollTop = consoleDiv.scrollHeight; // Автоскролл
        });

        // Обработка обновлений данных системы
        socket.on('console_update', function(data) {
            const consoleDiv = document.getElementById('system_update');
            const newLine = document.createElement('p');
        });

        // Загрузка истории при открытии
        fetch('/get_console_history')
            .then(response => response.json())
            .then(data => {
                const consoleDiv = document.getElementById('console-output');
                data.history.forEach(line => {
                    const p = document.createElement('p');
                    p.className = 'fonter';
                    p.textContent = line;
                    consoleDiv.appendChild(p);
                });
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            });

        // Обработчик обновления системных данных
        socket.on('system_update', function(data) {
            // Обновляем данные CPU
            document.getElementById('cpu-percent').textContent = data.cpu_percent + '%';
            document.getElementById('cpu-cores').textContent = data.cpu_cores;
            updateProgressBar('cpu-progress', data.cpu_percent);
            
            // Обновляем данные RAM
            document.getElementById('ram-total').textContent = data.ram_total + ' GB';
            document.getElementById('ram-used').textContent = data.ram_used + ' GB';
            document.getElementById('ram-available').textContent = data.ram_available + ' GB';
            document.getElementById('ram-percent').textContent = data.ram_percent + '%';
            updateProgressBar('ram-progress', data.ram_percent);
            
            // Обновляем данные диска
            document.getElementById('disk-total').textContent = data.disk_total + ' GB';
            document.getElementById('disk-used').textContent = data.disk_used + ' GB';
            document.getElementById('disk-free').textContent = data.disk_free + ' GB';
            document.getElementById('disk-percent').textContent = data.disk_percent + '%';
            updateProgressBar('disk-progress', data.disk_percent);
        });

        // Функция для обновления индикаторов прогресса
        function updateProgressBar(elementId, percent) {
            const progressBar = document.querySelector(`#${elementId} .progress-bar`);
            percent = Math.min(100, Math.max(0, percent)); // Ограничиваем значение 0-100
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            
            // Меняем цвет в зависимости от загрузки
            if (percent > 90) progressBar.style.background = '#dc3545';
            else if (percent > 70) progressBar.style.background = '#ffc107';
            else progressBar.style.background = '#0d6efd';
        }
        // Обработка ошибок
        socket.on('connect_error', (err) => {
            console.error('Ошибка подключения:', err);
        });
    });
    
</script>
{% endblock %}